<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š ê°•ì  ê²€ì‚¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 30px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .control-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-item label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .filter-item select, .filter-item input {
            padding: 8px 12px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1em;
            color: #666;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4facfe;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .table td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.4em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .domain-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .domain-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .domain-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .domain-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .domain-score {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
        }
        
        .domain-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .domain-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s ease;
        }
        
        .error-banner {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .success-banner {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .score-badge {
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            text-align: center;
        }
        
        .score-excellent {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
        
        .score-good {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        
        .score-average {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .score-below {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .strengths-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .strength-tag {
            background: #4facfe;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ê°•ì  ê²€ì‚¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <p>í•™ìƒë“¤ì˜ ê°•ì  ê²€ì‚¬ ê²°ê³¼ë¥¼ ê´€ë¦¬í•˜ê³  ë¶„ì„í•˜ì„¸ìš”</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <button class="btn btn-refresh" onclick="loadData()">
                    ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                </button>
                <button class="btn btn-export" onclick="exportToCSV()">
                    ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn" onclick="generateDemoData()">
                    ğŸ² ë°ëª¨ ë°ì´í„° ìƒì„±
                </button>
                <button class="btn btn-danger" onclick="clearAllData()">
                    ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ
                </button>
                <button class="btn" onclick="testFirebaseConnection()">
                    ğŸ”Œ Firebase ì—°ê²° í…ŒìŠ¤íŠ¸
                </button>
            </div>
            
            <div class="filters">
                <div class="filter-item">
                    <label for="gradeFilter">í•™ë…„ í•„í„°</label>
                    <select id="gradeFilter" onchange="applyFilters()">
                        <option value="">ì „ì²´</option>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                        <option value="4">4í•™ë…„</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="genderFilter">ì„±ë³„ í•„í„°</label>
                    <select id="genderFilter" onchange="applyFilters()">
                        <option value="">ì „ì²´</option>
                        <option value="ë‚¨">ë‚¨</option>
                        <option value="ì—¬">ì—¬</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="dateFilter">ë‚ ì§œ í•„í„°</label>
                    <input type="date" id="dateFilter" onchange="applyFilters()">
                </div>
            </div>
        </div>
        
        <div id="statusMessage"></div>
        
        <div class="stats" id="stats">
            <!-- í†µê³„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
        
        <div class="content">
            <div class="section">
                <div class="section-title">ğŸ“ˆ ì˜ì—­ë³„ í‰ê·  ì ìˆ˜</div>
                <div class="chart-container">
                    <div class="chart-title">4ê°œ ì˜ì—­ë³„ í•™ê¸‰ í‰ê· </div>
                    <div class="domain-chart" id="domainChart">
                        <!-- ì˜ì—­ë³„ ì°¨íŠ¸ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">ğŸ‘¥ í•™ìƒë³„ ê²€ì‚¬ ê²°ê³¼</div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>í•™ë…„</th>
                                <th>í•™ë²ˆ</th>
                                <th>ì„±ë³„</th>
                                <th>ê²€ì‚¬ì¼ì‹œ</th>
                                <th>ìƒìœ„ ê°•ì </th>
                                <th>ì „ì²´ í‰ê· </th>
                                <th>ìƒì„¸</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <!-- í•™ìƒ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, where, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Firebase êµ¬ì„± (ì‹¤ì œ í”„ë¡œì íŠ¸ ì„¤ì •)
        const firebaseConfig = {
            apiKey: "AIzaSyDrj01C1WXwAi6DdOTFdEt2pcsr-8qi76U",
            authDomain: "strengthsfinder-45ff8.firebaseapp.com",
            projectId: "strengthsfinder-45ff8",
            storageBucket: "strengthsfinder-45ff8.firebasestorage.app",
            messagingSenderId: "739606720301",
            appId: "1:739606720301:web:3b23bd465808132b38eda4"
        };

        let app, db;
        
        try {
            // Firebase ì´ˆê¸°í™”
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            
            // ì „ì—­ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
            window.firebaseDB = db;
            window.getDocs = getDocs;
            window.collection = collection;
            window.query = query;
            window.orderBy = orderBy;
            window.where = where;
            window.deleteDoc = deleteDoc;
            window.doc = doc;
            
            console.log('âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ');
            showMessage('Firebase ì—°ê²° ì„±ê³µ!', 'success');
        } catch (error) {
            console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            showMessage('Firebase ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
        }
    </script>

    <script>
        let allAssessments = [];
        let filteredAssessments = [];

        // ê°•ì  ë°ì´í„° ì •ì˜
        const strengthsData = {
            executing: [
                { korean: 'ì„±ì·¨ìš•', name: 'Achiever' },
                { korean: 'ë°°ì—´', name: 'Arranger' },
                { korean: 'ì‹ ë…', name: 'Belief' },
                { korean: 'ì¼ê´€ì„±', name: 'Consistency' },
                { korean: 'ì‹ ì¤‘í•¨', name: 'Deliberative' },
                { korean: 'ê·œìœ¨', name: 'Discipline' },
                { korean: 'ì§‘ì¤‘', name: 'Focus' },
                { korean: 'ì±…ì„ê°', name: 'Responsibility' },
                { korean: 'ë³µêµ¬', name: 'Restorative' }
            ],
            influencing: [
                { korean: 'í™œë°œí•¨', name: 'Activator' },
                { korean: 'ì§€íœ˜', name: 'Command' },
                { korean: 'ì†Œí†µ', name: 'Communication' },
                { korean: 'ê²½ìŸ', name: 'Competition' },
                { korean: 'ìµœê³ ì§€í–¥', name: 'Maximizer' },
                { korean: 'ìê¸°ì£¼ì¥', name: 'Self-Assurance' },
                { korean: 'ì¤‘ìš”ì„±', name: 'Significance' },
                { korean: 'ìŠ¹ë¶€ìš•', name: 'Woo' }
            ],
            relationship: [
                { korean: 'ì ì‘ì„±', name: 'Adaptability' },
                { korean: 'ì—°ê²°', name: 'Connectedness' },
                { korean: 'ê°œë°œ', name: 'Developer' },
                { korean: 'ê³µê°', name: 'Empathy' },
                { korean: 'ì¡°í™”', name: 'Harmony' },
                { korean: 'í¬ìš©', name: 'Includer' },
                { korean: 'ê°œë³„í™”', name: 'Individualization' },
                { korean: 'ê¸ì •', name: 'Positivity' },
                { korean: 'ê´€ê³„', name: 'Relator' }
            ],
            strategic: [
                { korean: 'ë¶„ì„', name: 'Analytical' },
                { korean: 'ë§¥ë½', name: 'Context' },
                { korean: 'ë¯¸ë˜ì§€í–¥', name: 'Futuristic' },
                { korean: 'ì‚¬ê³ ', name: 'Ideation' },
                { korean: 'ìˆ˜ì§‘', name: 'Input' },
                { korean: 'ì§€ì„±', name: 'Intellection' },
                { korean: 'í•™ìŠµ', name: 'Learner' },
                { korean: 'ì „ëµ', name: 'Strategic' }
            ]
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ì ì‹œ ëŒ€ê¸° í›„ ë°ì´í„° ë¡œë“œ (Firebase ì´ˆê¸°í™” ëŒ€ê¸°)
            setTimeout(() => {
                loadData();
            }, 1000);
        });

        function showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const className = type === 'error' ? 'error-banner' : 
                             type === 'success' ? 'success-banner' : 'debug-info';
            
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            // 3ì´ˆ í›„ ë©”ì‹œì§€ ìë™ ì œê±°
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        async function testFirebaseConnection() {
            showMessage('Firebase ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ì¤‘...', 'info');
            
            try {
                if (!window.firebaseDB) {
                    throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                // í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ì‹¤í–‰
                const testCollection = window.collection(window.firebaseDB, 'assessments');
                const testQuery = await window.getDocs(testCollection);
                
                const docCount = testQuery.size;
                showMessage(`âœ… Firebase ì—°ê²° ì„±ê³µ! ì´ ${docCount}ê°œì˜ ë¬¸ì„œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // ë¬¸ì„œ êµ¬ì¡° í™•ì¸
                if (docCount > 0) {
                    const firstDoc = testQuery.docs[0];
                    console.log('ì²« ë²ˆì§¸ ë¬¸ì„œ êµ¬ì¡°:', firstDoc.data());
                    showMessage(`ë¬¸ì„œ ìƒ˜í”Œ êµ¬ì¡°ë¥¼ ì½˜ì†”ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'info');
                }
                
            } catch (error) {
                console.error('Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                showMessage(`âŒ Firebase ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function loadData() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                if (!window.firebaseDB) {
                    throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë°ëª¨ ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.');
                }

                showMessage('Firestoreì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');

                // Firestoreì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const q = window.query(
                    window.collection(window.firebaseDB, 'assessments'),
                    window.orderBy('completedAt', 'desc')
                );
                
                const querySnapshot = await window.getDocs(q);
                allAssessments = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('ë¬¸ì„œ ë°ì´í„°:', data); // ë””ë²„ê¹…ìš©
                    allAssessments.push({
                        id: doc.id,
                        ...data
                    });
                });

                if (allAssessments.length === 0) {
                    showMessage('ê²€ì‚¬ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë°ëª¨ ë°ì´í„°ë¥¼ ìƒì„±í•˜ê±°ë‚˜ í•™ìƒë“¤ì´ ê²€ì‚¬ë¥¼ ì™„ë£Œí•˜ê¸°ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'info');
                    generateDemoData(); // ìë™ìœ¼ë¡œ ë°ëª¨ ë°ì´í„° ìƒì„±
                    return;
                }

                showMessage(`âœ… ${allAssessments.length}ê°œì˜ ê²€ì‚¬ ê²°ê³¼ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!`, 'success');
                
                filteredAssessments = [...allAssessments];
                updateAllUI();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showMessage(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}. ë°ëª¨ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.`, 'error');
                generateDemoData();
            } finally {
                loading.style.display = 'none';
            }
        }

        function generateDemoData() {
            const demoStudents = [
                { name: 'ê¹€ë¯¼ìˆ˜', grade: '1', studentId: '2024001', gender: 'ë‚¨' },
                { name: 'ì´ì§€ì˜', grade: '1', studentId: '2024002', gender: 'ì—¬' },
                { name: 'ë°•ì¤€í˜¸', grade: '2', studentId: '2023003', gender: 'ë‚¨' },
                { name: 'ìµœì„œì—°', grade: '2', studentId: '2023004', gender: 'ì—¬' },
                { name: 'ì •ìš°ì§„', grade: '3', studentId: '2022005', gender: 'ë‚¨' },
                { name: 'í•œì†Œí¬', grade: '3', studentId: '2022006', gender: 'ì—¬' },
                { name: 'ì¡°í˜„ìš°', grade: '4', studentId: '2021007', gender: 'ë‚¨' },
                { name: 'ìœ¤ì±„ì›', grade: '4', studentId: '2021008', gender: 'ì—¬' }
            ];

            allAssessments = demoStudents.map((student, index) => {
                const allStrengths = [];
                Object.values(strengthsData).forEach(domain => {
                    allStrengths.push(...domain);
                });

                // ëœë¤í•˜ê²Œ ê°•ì ì— ì ìˆ˜ ë¶€ì—¬
                const results = allStrengths.map(strength => ({
                    ...strength,
                    score: Math.random() * 2 + 3 // 3-5ì  ì‚¬ì´ ëœë¤
                }));

                // ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                results.sort((a, b) => b.score - a.score);

                // ìƒìœ„ 5ê°œ ê°•ì 
                const topStrengths = results.slice(0, 5);

                // ì˜ì—­ë³„ ì ìˆ˜ ê³„ì‚°
                const domainScores = {};
                Object.keys(strengthsData).forEach(domain => {
                    const domainStrengths = results.filter(result => 
                        strengthsData[domain].some(s => s.name === result.name)
                    );
                    const averageScore = domainStrengths.reduce((sum, s) => sum + s.score, 0) / domainStrengths.length;
                    domainScores[domain] = { score: averageScore };
                });

                // ê²€ì‚¬ ì™„ë£Œì¼ (ìµœê·¼ 30ì¼ ë‚´ ëœë¤)
                const daysAgo = Math.floor(Math.random() * 30);
                const completedAt = new Date();
                completedAt.setDate(completedAt.getDate() - daysAgo);

                return {
                    id: `demo_${index}`,
                    studentInfo: student,
                    results: results,
                    topStrengths: topStrengths,
                    domainScores: domainScores,
                    completedAt: completedAt.toISOString(),
                    timestamp: completedAt.toISOString()
                };
            });

            filteredAssessments = [...allAssessments];
            updateAllUI();
            showMessage('ğŸ² ë°ëª¨ ë°ì´í„°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        function updateAllUI() {
            updateStats();
            updateDomainChart();
            updateStudentsTable();
        }

        function updateStats() {
            const totalStudents = filteredAssessments.length;
            const completedToday = filteredAssessments.filter(assessment => {
                const today = new Date().toDateString();
                const assessmentDate = new Date(assessment.completedAt).toDateString();
                return today === assessmentDate;
            }).length;

            const averageScores = calculateAverageScores();
            const overallAverage = averageScores.overall;
            const topStrengths = analyzeTopStrengths();

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-number">${totalStudents}</div>
                    <div class="stat-label">ì´ ê²€ì‚¬ ì™„ë£Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-number">${completedToday}</div>
                    <div class="stat-label">ì˜¤ëŠ˜ ì™„ë£Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â­</div>
                    <div class="stat-number">${overallAverage}</div>
                    <div class="stat-label">ì „ì²´ í‰ê·  ì ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ†</div>
                    <div class="stat-number">${topStrengths[0]?.korean || 'N/A'}</div>
                    <div class="stat-label">ìµœë‹¤ ìƒìœ„ ê°•ì </div>
                </div>
            `;

            document.getElementById('stats').innerHTML = statsHtml;
        }

        function calculateAverageScores() {
            if (filteredAssessments.length === 0) {
                return { overall: '0.0', domains: {} };
            }

            const domainTotals = {
                executing: { total: 0, count: 0 },
                influencing: { total: 0, count: 0 },
                relationship: { total: 0, count: 0 },
                strategic: { total: 0, count: 0 }
            };

            let overallTotal = 0;
            let overallCount = 0;

            filteredAssessments.forEach(assessment => {
                if (assessment.domainScores) {
                    Object.keys(assessment.domainScores).forEach(domain => {
                        const score = assessment.domainScores[domain].score;
                        if (score && score > 0) {
                            domainTotals[domain].total += score;
                            domainTotals[domain].count++;
                            overallTotal += score;
                            overallCount++;
                        }
                    });
                }
            });

            const domains = {};
            Object.keys(domainTotals).forEach(domain => {
                const data = domainTotals[domain];
                domains[domain] = data.count > 0 ? (data.total / data.count).toFixed(1) : '0.0';
            });

            const overall = overallCount > 0 ? (overallTotal / overallCount).toFixed(1) : '0.0';

            return { overall, domains };
        }

        function analyzeTopStrengths() {
            const strengthCounts = {};

            filteredAssessments.forEach(assessment => {
                if (assessment.topStrengths) {
                    assessment.topStrengths.forEach(strength => {
                        if (!strengthCounts[strength.korean]) {
                            strengthCounts[strength.korean] = 0;
                        }
                        strengthCounts[strength.korean]++;
                    });
                }
            });

            return Object.entries(strengthCounts)
                .sort(([,a], [,b]) => b - a)
                .map(([korean, count]) => ({ korean, count }));
        }

        function updateDomainChart() {
            const averageScores = calculateAverageScores();
            const domainInfo = {
                executing: { name: 'ì‹¤í–‰ë ¥', icon: 'ğŸ¯' },
                influencing: { name: 'ì˜í–¥ë ¥', icon: 'ğŸŒŸ' },
                relationship: { name: 'ê´€ê³„êµ¬ì¶•', icon: 'ğŸ¤' },
                strategic: { name: 'ì „ëµì  ì‚¬ê³ ', icon: 'ğŸ§ ' }
            };

            const chartHtml = Object.keys(domainInfo).map(domain => {
                const score = averageScores.domains[domain] || '0.0';
                const percentage = ((parseFloat(score) / 5) * 100).toFixed(0);
                
                return `
                    <div class="domain-item">
                        <div class="domain-icon">${domainInfo[domain].icon}</div>
                        <div class="domain-name">${domainInfo[domain].name}</div>
                        <div class="domain-score">${score}</div>
                        <div class="domain-bar">
                            <div class="domain-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('domainChart').innerHTML = chartHtml;
        }

        function updateStudentsTable() {
            const tbody = document.getElementById('studentsTable');
            
            if (filteredAssessments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">ê²€ì‚¬ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            const tableHtml = filteredAssessments.map(assessment => {
                const student = assessment.studentInfo;
                const topStrengths = assessment.topStrengths?.slice(0, 3) || [];
                const completedDate = new Date(assessment.completedAt).toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const overallAverage = calculateStudentAverage(assessment);
                const scoreClass = getScoreClass(overallAverage);

                const strengthsHtml = topStrengths.map(strength => 
                    `<span class="strength-tag">${strength.korean}</span>`
                ).join('');

                return `
                    <tr>
                        <td><strong>${student.name}</strong></td>
                        <td>${student.grade}í•™ë…„</td>
                        <td>${student.studentId}</td>
                        <td>${student.gender}</td>
                        <td>${completedDate}</td>
                        <td>
                            <div class="strengths-list">
                                ${strengthsHtml}
                            </div>
                        </td>
                        <td>
                            <span class="score-badge ${scoreClass}">
                                ${overallAverage}ì 
                            </span>
                        </td>
                        <td>
                            <button class="btn" onclick="showStudentDetail('${assessment.id}')" style="padding: 8px 16px; font-size: 0.9em;">
                                ìƒì„¸ë³´ê¸°
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = tableHtml;
        }

        function calculateStudentAverage(assessment) {
            if (!assessment.domainScores) return '0.0';
            
            const scores = Object.values(assessment.domainScores).map(domain => domain.score);
            const validScores = scores.filter(score => score > 0);
            
            if (validScores.length === 0) return '0.0';
            
            const average = validScores.reduce((sum, score) => sum + score, 0) / validScores.length;
            return average.toFixed(1);
        }

        function getScoreClass(score) {
            const numScore = parseFloat(score);
            if (numScore >= 4.0) return 'score-excellent';
            if (numScore >= 3.5) return 'score-good';
            if (numScore >= 3.0) return 'score-average';
            return 'score-below';
        }

        function applyFilters() {
            const gradeFilter = document.getElementById('gradeFilter').value;
            const genderFilter = document.getElementById('genderFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            filteredAssessments = allAssessments.filter(assessment => {
                const student = assessment.studentInfo;
                const assessmentDate = new Date(assessment.completedAt).toDateString();
                const filterDate = dateFilter ? new Date(dateFilter).toDateString() : null;

                return (!gradeFilter || student.grade === gradeFilter) &&
                       (!genderFilter || student.gender === genderFilter) &&
                       (!filterDate || assessmentDate === filterDate);
            });

            updateAllUI();
            showMessage(`í•„í„° ì ìš© ì™„ë£Œ: ${filteredAssessments.length}ê°œì˜ ê²°ê³¼`, 'info');
        }

        function showStudentDetail(assessmentId) {
            const assessment = allAssessments.find(a => a.id === assessmentId);
            if (!assessment) return;

            const student = assessment.studentInfo;
            const results = assessment.results || [];
            const domainScores = assessment.domainScores || {};

            let detailHtml = `
                <div style="max-width: 600px; margin: 0 auto;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">
                        ${student.name} (${student.grade}í•™ë…„ / í•™ë²ˆ: ${student.studentId} / ${student.gender})
                    </h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">ì˜ì—­ë³„ ì ìˆ˜</h3>
            `;

            Object.keys(domainScores).forEach(domain => {
                const domainInfo = {
                    executing: { name: 'ì‹¤í–‰ë ¥', icon: 'ğŸ¯' },
                    influencing: { name: 'ì˜í–¥ë ¥', icon: 'ğŸŒŸ' },
                    relationship: { name: 'ê´€ê³„êµ¬ì¶•', icon: 'ğŸ¤' },
                    strategic: { name: 'ì „ëµì  ì‚¬ê³ ', icon: 'ğŸ§ ' }
                };
                
                const info = domainInfo[domain];
                const score = domainScores[domain].score;
                const percentage = ((score / 5) * 100).toFixed(0);

                detailHtml += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span>${info.icon} ${info.name}</span>
                            <span style="font-weight: bold; color: #4facfe;">${score.toFixed(1)}ì </span>
                        </div>
                        <div style="background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); height: 100%; width: ${percentage}%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            });

            detailHtml += `
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">ìƒìœ„ ê°•ì  ìˆœìœ„</h3>
            `;

            results.slice(0, 10).forEach((result, index) => {
                const rank = index + 1;
                const medalIcon = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] || `${rank}ìœ„`;
                
                detailHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; background: white; border-radius: 8px;">
                        <div>
                            <span style="margin-right: 10px;">${medalIcon}</span>
                            <strong>${result.korean}</strong>
                            <span style="color: #666; margin-left: 5px;">(${result.name})</span>
                        </div>
                        <span style="font-weight: bold; color: #4facfe;">${result.score.toFixed(1)}ì </span>
                    </div>
                `;
            });

            detailHtml += `
                    </div>
                </div>
            `;

            // ìƒˆ ì°½ì—ì„œ ìƒì„¸ ì •ë³´ í‘œì‹œ
            const newWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${student.name} ê°•ì  ê²€ì‚¬ ê²°ê³¼</title>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f8f9fa; }
                        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
                    </style>
                </head>
                <body>
                    <div class="container">
                        ${detailHtml}
                    </div>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        async function clearAllData() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                showMessage('ë°ì´í„° ì‚­ì œ ì¤‘...', 'info');

                if (window.firebaseDB && window.getDocs && window.deleteDoc && window.doc) {
                    // Firebaseì—ì„œ ì‹¤ì œ ë°ì´í„° ì‚­ì œ
                    const q = window.query(window.collection(window.firebaseDB, 'assessments'));
                    const querySnapshot = await window.getDocs(q);
                    
                    const deletePromises = [];
                    querySnapshot.forEach((document) => {
                        deletePromises.push(window.deleteDoc(window.doc(window.firebaseDB, 'assessments', document.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    showMessage(`âœ… Firebaseì—ì„œ ${deletePromises.length}ê°œì˜ ë¬¸ì„œë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`, 'success');
                }

                // ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”
                allAssessments = [];
                filteredAssessments = [];
                updateAllUI();

            } catch (error) {
                console.error('ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:', error);
                showMessage(`âŒ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function exportToCSV() {
            if (filteredAssessments.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                // CSV í—¤ë”
                const headers = [
                    'ì´ë¦„', 'í•™ë…„', 'í•™ë²ˆ', 'ì„±ë³„', 'ê²€ì‚¬ì¼ì‹œ',
                    'ì‹¤í–‰ë ¥ ì ìˆ˜', 'ì˜í–¥ë ¥ ì ìˆ˜', 'ê´€ê³„êµ¬ì¶• ì ìˆ˜', 'ì „ëµì ì‚¬ê³  ì ìˆ˜', 'ì „ì²´í‰ê· ',
                    '1ìœ„ ê°•ì ', '2ìœ„ ê°•ì ', '3ìœ„ ê°•ì ', '4ìœ„ ê°•ì ', '5ìœ„ ê°•ì '
                ];

                // CSV ë°ì´í„° ìƒì„±
                const csvData = filteredAssessments.map(assessment => {
                    const student = assessment.studentInfo;
                    const domainScores = assessment.domainScores || {};
                    const topStrengths = assessment.topStrengths || [];
                    
                    const executing = domainScores.executing?.score?.toFixed(1) || '0.0';
                    const influencing = domainScores.influencing?.score?.toFixed(1) || '0.0';
                    const relationship = domainScores.relationship?.score?.toFixed(1) || '0.0';
                    const strategic = domainScores.strategic?.score?.toFixed(1) || '0.0';
                    
                    const overall = calculateStudentAverage(assessment);
                    const completedDate = new Date(assessment.completedAt).toLocaleString('ko-KR');

                    return [
                        student.name,
                        student.grade + 'í•™ë…„',
                        student.studentId,
                        student.gender,
                        completedDate,
                        executing,
                        influencing,
                        relationship,
                        strategic,
                        overall,
                        topStrengths[0]?.korean || '',
                        topStrengths[1]?.korean || '',
                        topStrengths[2]?.korean || '',
                        topStrengths[3]?.korean || '',
                        topStrengths[4]?.korean || ''
                    ];
                });

                // CSV ë¬¸ìì—´ ìƒì„±
                const csvContent = [headers, ...csvData]
                    .map(row => row.map(field => `"${field}"`).join(','))
                    .join('\n');

                // UTF-8 BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

                // ë‹¤ìš´ë¡œë“œ
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ê°•ì ê²€ì‚¬ê²°ê³¼_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(`âœ… CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! (${filteredAssessments.length}ê°œ ë°ì´í„°)`, 'success');

            } catch (error) {
                console.error('CSV ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showMessage(`âŒ CSV ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
