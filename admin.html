<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∞ïÏ†ê Í≤ÄÏÇ¨ Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 30px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .control-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .control-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .control-item select, .control-item input {
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .control-item select:focus, .control-item input:focus {
            border-color: #4facfe;
            outline: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1em;
            color: #666;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4facfe;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .table td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .score-badge {
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            text-align: center;
        }
        
        .score-excellent {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
        
        .score-good {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        
        .score-average {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .score-below {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .strengths-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .strength-tag {
            background: #4facfe;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.4em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .domain-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .domain-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .domain-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .domain-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .domain-score {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
        }
        
        .domain-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .domain-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s ease;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-item label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .filter-item select, .filter-item input {
            padding: 8px 12px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-item {
                min-width: auto;
            }
            
            .stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Í∞ïÏ†ê Í≤ÄÏÇ¨ Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú</h1>
            <p>ÌïôÏÉùÎì§Ïùò Í∞ïÏ†ê Í≤ÄÏÇ¨ Í≤∞Í≥ºÎ•º Í¥ÄÎ¶¨ÌïòÍ≥† Î∂ÑÏÑùÌïòÏÑ∏Ïöî</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <button class="btn btn-refresh" onclick="loadData()">
                    üîÑ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
                </button>
                <button class="btn btn-export" onclick="exportToCSV()">
                    üì• CSV Îã§Ïö¥Î°úÎìú
                </button>
                <button class="btn" onclick="generateDemoData()">
                    üé≤ Îç∞Î™® Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                </button>
            </div>
            
            <div class="filters">
                <div class="filter-item">
                    <label for="gradeFilter">ÌïôÎÖÑ ÌïÑÌÑ∞</label>
                    <select id="gradeFilter" onchange="applyFilters()">
                        <option value="">Ï†ÑÏ≤¥</option>
                        <option value="1">1ÌïôÎÖÑ</option>
                        <option value="2">2ÌïôÎÖÑ</option>
                        <option value="3">3ÌïôÎÖÑ</option>
                        <option value="4">4ÌïôÎÖÑ</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="genderFilter">ÏÑ±Î≥Ñ ÌïÑÌÑ∞</label>
                    <select id="genderFilter" onchange="applyFilters()">
                        <option value="">Ï†ÑÏ≤¥</option>
                        <option value="ÎÇ®">ÎÇ®</option>
                        <option value="Ïó¨">Ïó¨</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="dateFilter">ÎÇ†Ïßú ÌïÑÌÑ∞</label>
                    <input type="date" id="dateFilter" onchange="applyFilters()">
                </div>
            </div>
        </div>
        
        <div class="stats" id="stats">
            <!-- ÌÜµÍ≥Ñ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
        </div>
        
        <div class="content">
            <div class="section">
                <div class="section-title">üìà ÏòÅÏó≠Î≥Ñ ÌèâÍ∑† Ï†êÏàò</div>
                <div class="chart-container">
                    <div class="chart-title">4Í∞ú ÏòÅÏó≠Î≥Ñ ÌïôÍ∏â ÌèâÍ∑†</div>
                    <div class="domain-chart" id="domainChart">
                        <!-- ÏòÅÏó≠Î≥Ñ Ï∞®Ìä∏Í∞Ä Ïó¨Í∏∞Ïóê ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">üë• ÌïôÏÉùÎ≥Ñ Í≤ÄÏÇ¨ Í≤∞Í≥º</div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ïù¥Î¶Ñ</th>
                                <th>ÌïôÎÖÑ</th>
                                <th>ÌïôÎ≤à</th>
                                <th>ÏÑ±Î≥Ñ</th>
                                <th>Í≤ÄÏÇ¨ÏùºÏãú</th>
                                <th>ÏÉÅÏúÑ Í∞ïÏ†ê</th>
                                <th>Ï†ÑÏ≤¥ ÌèâÍ∑†</th>
                                <th>ÏÉÅÏÑ∏</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <!-- ÌïôÏÉù Îç∞Ïù¥ÌÑ∞Í∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>
        
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">üìä</div>
            <h3>ÏïÑÏßÅ Í≤ÄÏÇ¨ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p>ÌïôÏÉùÎì§Ïù¥ Í∞ïÏ†ê Í≤ÄÏÇ¨Î•º ÏôÑÎ£åÌïòÎ©¥ Ïó¨Í∏∞Ïóê Í≤∞Í≥ºÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§.</p>
        </div>
    </div>

    <script>
        let allAssessments = [];
        let filteredAssessments = [];

        // Í∞ïÏ†ê Îç∞Ïù¥ÌÑ∞ Ï†ïÏùò
        const strengthsData = {
            executing: [
                { korean: 'ÏÑ±Ï∑®Ïöï', name: 'Achiever' },
                { korean: 'Î∞∞Ïó¥', name: 'Arranger' },
                { korean: 'Ïã†ÎÖê', name: 'Belief' },
                { korean: 'ÏùºÍ¥ÄÏÑ±', name: 'Consistency' },
                { korean: 'Ïã†Ï§ëÌï®', name: 'Deliberative' },
                { korean: 'Í∑úÏú®', name: 'Discipline' },
                { korean: 'ÏßëÏ§ë', name: 'Focus' },
                { korean: 'Ï±ÖÏûÑÍ∞ê', name: 'Responsibility' },
                { korean: 'Î≥µÍµ¨', name: 'Restorative' }
            ],
            influencing: [
                { korean: 'ÌôúÎ∞úÌï®', name: 'Activator' },
                { korean: 'ÏßÄÌúò', name: 'Command' },
                { korean: 'ÏÜåÌÜµ', name: 'Communication' },
                { korean: 'Í≤ΩÏüÅ', name: 'Competition' },
                { korean: 'ÏµúÍ≥†ÏßÄÌñ•', name: 'Maximizer' },
                { korean: 'ÏûêÍ∏∞Ï£ºÏû•', name: 'Self-Assurance' },
                { korean: 'Ï§ëÏöîÏÑ±', name: 'Significance' },
                { korean: 'ÏäπÎ∂ÄÏöï', name: 'Woo' }
            ],
            relationship: [
                { korean: 'Ï†ÅÏùëÏÑ±', name: 'Adaptability' },
                { korean: 'Ïó∞Í≤∞', name: 'Connectedness' },
                { korean: 'Í∞úÎ∞ú', name: 'Developer' },
                { korean: 'Í≥µÍ∞ê', name: 'Empathy' },
                { korean: 'Ï°∞Ìôî', name: 'Harmony' },
                { korean: 'Ìè¨Ïö©', name: 'Includer' },
                { korean: 'Í∞úÎ≥ÑÌôî', name: 'Individualization' },
                { korean: 'Í∏çÏ†ï', name: 'Positivity' },
                { korean: 'Í¥ÄÍ≥Ñ', name: 'Relator' }
            ],
            strategic: [
                { korean: 'Î∂ÑÏÑù', name: 'Analytical' },
                { korean: 'Îß•ÎùΩ', name: 'Context' },
                { korean: 'ÎØ∏ÎûòÏßÄÌñ•', name: 'Futuristic' },
                { korean: 'ÏÇ¨Í≥†', name: 'Ideation' },
                { korean: 'ÏàòÏßë', name: 'Input' },
                { korean: 'ÏßÄÏÑ±', name: 'Intellection' },
                { korean: 'ÌïôÏäµ', name: 'Learner' },
                { korean: 'Ï†ÑÎûµ', name: 'Strategic' }
            ]
        };

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        function generateDemoData() {
            const demoStudents = [
                { name: 'ÍπÄÎØºÏàò', grade: '1', studentId: '2024001', gender: 'ÎÇ®' },
                { name: 'Ïù¥ÏßÄÏòÅ', grade: '1', studentId: '2024002', gender: 'Ïó¨' },
                { name: 'Î∞ïÏ§ÄÌò∏', grade: '2', studentId: '2023003', gender: 'ÎÇ®' },
                { name: 'ÏµúÏÑúÏó∞', grade: '2', studentId: '2023004', gender: 'Ïó¨' },
                { name: 'Ï†ïÏö∞ÏßÑ', grade: '3', studentId: '2022005', gender: 'ÎÇ®' },
                { name: 'ÌïúÏÜåÌù¨', grade: '3', studentId: '2022006', gender: 'Ïó¨' },
                { name: 'Ï°∞ÌòÑÏö∞', grade: '4', studentId: '2021007', gender: 'ÎÇ®' },
                { name: 'Ïú§Ï±ÑÏõê', grade: '4', studentId: '2021008', gender: 'Ïó¨' }
            ];

            allAssessments = demoStudents.map((student, index) => {
                const allStrengths = [];
                Object.values(strengthsData).forEach(domain => {
                    allStrengths.push(...domain);
                });

                // ÎûúÎç§ÌïòÍ≤å Í∞ïÏ†êÏóê Ï†êÏàò Î∂ÄÏó¨
                const results = allStrengths.map(strength => ({
                    ...strength,
                    score: Math.random() * 2 + 3 // 3-5Ï†ê ÏÇ¨Ïù¥ ÎûúÎç§
                }));

                // Ï†êÏàò Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨
                results.sort((a, b) => b.score - a.score);

                // ÏÉÅÏúÑ 5Í∞ú Í∞ïÏ†ê
                const topStrengths = results.slice(0, 5);

                // ÏòÅÏó≠Î≥Ñ Ï†êÏàò Í≥ÑÏÇ∞
                const domainScores = {};
                Object.keys(strengthsData).forEach(domain => {
                    const domainStrengths = results.filter(result => 
                        strengthsData[domain].some(s => s.name === result.name)
                    );
                    const averageScore = domainStrengths.reduce((sum, s) => sum + s.score, 0) / domainStrengths.length;
                    domainScores[domain] = { score: averageScore };
                });

                // Í≤ÄÏÇ¨ ÏôÑÎ£åÏùº (ÏµúÍ∑º 30Ïùº ÎÇ¥ ÎûúÎç§)
                const daysAgo = Math.floor(Math.random() * 30);
                const completedAt = new Date();
                completedAt.setDate(completedAt.getDate() - daysAgo);

                return {
                    id: `demo_${index}`,
                    studentInfo: student,
                    results: results,
                    topStrengths: topStrengths,
                    domainScores: domainScores,
                    completedAt: completedAt.toISOString(),
                    timestamp: completedAt.toISOString()
                };
            });

            filteredAssessments = [...allAssessments];
            updateStats();
            updateDomainChart();
            updateStudentsTable();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }

        async function loadData() {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');
            
            loading.style.display = 'block';
            emptyState.style.display = 'none';

            // Ïã§Ï†ú Firebase Ïó∞Í≤∞Ïù¥ ÏóÜÏúºÎØÄÎ°ú Îç∞Î™® Îç∞Ïù¥ÌÑ∞Î°ú ÎåÄÏ≤¥
            setTimeout(() => {
                if (allAssessments.length === 0) {
                    generateDemoData();
                } else {
                    loading.style.display = 'none';
                }
            }, 1000);
        }

        function updateStats() {
            const totalStudents = filteredAssessments.length;
            const completedToday = filteredAssessments.filter(assessment => {
                const today = new Date().toDateString();
                const assessmentDate = new Date(assessment.completedAt).toDateString();
                return today === assessmentDate;
            }).length;

            const averageScores = calculateAverageScores();
            const overallAverage = averageScores.overall;
            const topStrengths = analyzeTopStrengths();

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-number">${totalStudents}</div>
                    <div class="stat-label">Ï¥ù Í≤ÄÏÇ¨ ÏôÑÎ£å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-number">${completedToday}</div>
                    <div class="stat-label">Ïò§Îäò ÏôÑÎ£å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-number">${overallAverage}</div>
                    <div class="stat-label">Ï†ÑÏ≤¥ ÌèâÍ∑† Ï†êÏàò</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-number">${topStrengths[0]?.korean || 'N/A'}</div>
                    <div class="stat-label">ÏµúÎã§ ÏÉÅÏúÑ Í∞ïÏ†ê</div>
                </div>
            `;

            document.getElementById('stats').innerHTML = statsHtml;
        }

        function calculateAverageScores() {
            if (filteredAssessments.length === 0) {
                return { overall: '0.0', domains: {} };
            }

            const domainTotals = {
                executing: { total: 0, count: 0 },
                influencing: { total: 0, count: 0 },
                relationship: { total: 0, count: 0 },
                strategic: { total: 0, count: 0 }
            };

            let overallTotal = 0;
            let overallCount = 0;

            filteredAssessments.forEach(assessment => {
                if (assessment.domainScores) {
                    Object.keys(assessment.domainScores).forEach(domain => {
                        const score = assessment.domainScores[domain].score;
                        if (score && score > 0) {
                            domainTotals[domain].total += score;
                            domainTotals[domain].count++;
                            overallTotal += score;
                            overallCount++;
                        }
                    });
                }
            });

            const domains = {};
            Object.keys(domainTotals).forEach(domain => {
                const data = domainTotals[domain];
                domains[domain] = data.count > 0 ? (data.total / data.count).toFixed(1) : '0.0';
            });

            const overall = overallCount > 0 ? (overallTotal / overallCount).toFixed(1) : '0.0';

            return { overall, domains };
        }

        function analyzeTopStrengths() {
            const strengthCounts = {};

            filteredAssessments.forEach(assessment => {
                if (assessment.topStrengths) {
                    assessment.topStrengths.forEach(strength => {
                        if (!strengthCounts[strength.korean]) {
                            strengthCounts[strength.korean] = 0;
                        }
                        strengthCounts[strength.korean]++;
                    });
                }
            });

            return Object.entries(strengthCounts)
                .sort(([,a], [,b]) => b - a)
                .map(([korean, count]) => ({ korean, count }));
        }

        function updateDomainChart() {
            const averageScores = calculateAverageScores();
            const domainInfo = {
                executing: { name: 'Ïã§ÌñâÎ†•', icon: 'üéØ' },
                influencing: { name: 'ÏòÅÌñ•Î†•', icon: 'üåü' },
                relationship: { name: 'Í¥ÄÍ≥ÑÍµ¨Ï∂ï', icon: 'ü§ù' },
                strategic: { name: 'Ï†ÑÎûµÏ†Å ÏÇ¨Í≥†', icon: 'üß†' }
            };

            const chartHtml = Object.keys(domainInfo).map(domain => {
                const score = averageScores.domains[domain] || '0.0';
                const percentage = ((parseFloat(score) / 5) * 100).toFixed(0);
                
                return `
                    <div class="domain-item">
                        <div class="domain-icon">${domainInfo[domain].icon}</div>
                        <div class="domain-name">${domainInfo[domain].name}</div>
                        <div class="domain-score">${score}</div>
                        <div class="domain-bar">
                            <div class="domain-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('domainChart').innerHTML = chartHtml;
        }

        function updateStudentsTable() {
            const tbody = document.getElementById('studentsTable');
            
            if (filteredAssessments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Í≤ÄÏÇ¨ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }

            const tableHtml = filteredAssessments.map(assessment => {
                const student = assessment.studentInfo;
                const topStrengths = assessment.topStrengths?.slice(0, 3) || [];
                const completedDate = new Date(assessment.completedAt).toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const overallAverage = calculateStudentAverage(assessment);
                const scoreClass = getScoreClass(overallAverage);

                const strengthsHtml = topStrengths.map(strength => 
                    `<span class="strength-tag">${strength.korean}</span>`
                ).join('');

                return `
                    <tr>
                        <td><strong>${student.name}</strong></td>
                        <td>${student.grade}ÌïôÎÖÑ</td>
                        <td>${student.studentId}</td>
                        <td>${student.gender}</td>
                        <td>${completedDate}</td>
                        <td>
                            <div class="strengths-list">
                                ${strengthsHtml}
                            </div>
                        </td>
                        <td>
                            <span class="score-badge ${scoreClass}">
                                ${overallAverage}Ï†ê
                            </span>
                        </td>
                        <td>
                            <button class="btn" onclick="showStudentDetail('${assessment.id}')" style="padding: 8px 16px; font-size: 0.9em;">
                                ÏÉÅÏÑ∏Î≥¥Í∏∞
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = tableHtml;
        }

        function calculateStudentAverage(assessment) {
            if (!assessment.domainScores) return '0.0';
            
            const scores = Object.values(assessment.domainScores).map(domain => domain.score);
            const validScores = scores.filter(score => score > 0);
            
            if (validScores.length === 0) return '0.0';
            
            const average = validScores.reduce((sum, score) => sum + score, 0) / validScores.length;
            return average.toFixed(1);
        }

        function getScoreClass(score) {
            const numScore = parseFloat(score);
            if (numScore >= 4.0) return 'score-excellent';
            if (numScore >= 3.5) return 'score-good';
            if (numScore >= 3.0) return 'score-average';
            return 'score-below';
        }

        function applyFilters() {
            const gradeFilter = document.getElementById('gradeFilter').value;
            const genderFilter = document.getElementById('genderFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            filteredAssessments = allAssessments.filter(assessment => {
                const student = assessment.studentInfo;
                const assessmentDate = new Date(assessment.completedAt).toDateString();
                const filterDate = dateFilter ? new Date(dateFilter).toDateString() : null;

                return (!gradeFilter || student.grade === gradeFilter) &&
                       (!genderFilter || student.gender === genderFilter) &&
                       (!filterDate || assessmentDate === filterDate);
            });

            updateStats();
            updateDomainChart();
            updateStudentsTable();
        }

        function showStudentDetail(assessmentId) {
            const assessment = allAssessments.find(a => a.id === assessmentId);
            if (!assessment) return;

            const student = assessment.studentInfo;
            const results = assessment.results || [];
            const domainScores = assessment.domainScores || {};

            let detailHtml = `
                <div style="max-width: 600px; margin: 0 auto;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">
                        ${student.name} (${student.grade}ÌïôÎÖÑ / ÌïôÎ≤à: ${student.studentId} / ${student.gender})
                    </h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">ÏòÅÏó≠Î≥Ñ Ï†êÏàò</h3>
            `;

            Object.keys(domainScores).forEach(domain => {
                const domainInfo = {
                    executing: { name: 'Ïã§ÌñâÎ†•', icon: 'üéØ' },
                    influencing: { name: 'ÏòÅÌñ•Î†•', icon: 'üåü' },
                    relationship: { name: 'Í¥ÄÍ≥ÑÍµ¨Ï∂ï', icon: 'ü§ù' },
                    strategic: { name: 'Ï†ÑÎûµÏ†Å ÏÇ¨Í≥†', icon: 'üß†' }
                };
                
                const info = domainInfo[domain];
                const score = domainScores[domain].score;
                const percentage = ((score / 5) * 100).toFixed(0);

                detailHtml += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span>${info.icon} ${info.name}</span>
                            <span style="font-weight: bold; color: #4facfe;">${score.toFixed(1)}Ï†ê</span>
                        </div>
                        <div style="background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); height: 100%; width: ${percentage}%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            });

            detailHtml += `
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">ÏÉÅÏúÑ Í∞ïÏ†ê ÏàúÏúÑ</h3>
            `;

            results.slice(0, 10).forEach((result, index) => {
                const rank = index + 1;
                const medalIcon = ['ü•á', 'ü•à', 'ü•â'][index] || `${rank}ÏúÑ`;
                
                detailHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; background: white; border-radius: 8px;">
                        <div>
                            <span style="margin-right: 10px;">${medalIcon}</span>
                            <strong>${result.korean}</strong>
                            <span style="color: #666; margin-left: 5px;">(${result.name})</span>
                        </div>
                        <span style="font-weight: bold; color: #4facfe;">${result.score.toFixed(1)}Ï†ê</span>
                    </div>
                `;
            });

            detailHtml += `
                    </div>
                </div>
            `;

            // ÏÉà Ï∞ΩÏóêÏÑú ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú
            const newWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${student.name} Í∞ïÏ†ê Í≤ÄÏÇ¨ Í≤∞Í≥º</title>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f8f9fa; }
                        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
                    </style>
                </head>
                <body>
                    <div class="container">
                        ${detailHtml}
                    </div>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        async function exportToCSV() {
            if (filteredAssessments.length === 0) {
                alert('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // CSV Ìó§Îçî
            const headers = [
                'Ïù¥Î¶Ñ', 'ÌïôÎÖÑ', 'ÌïôÎ≤à', 'ÏÑ±Î≥Ñ', 'Í≤ÄÏÇ¨ÏùºÏãú',
                'Ïã§ÌñâÎ†• Ï†êÏàò', 'ÏòÅÌñ•Î†• Ï†êÏàò', 'Í¥ÄÍ≥ÑÍµ¨Ï∂ï Ï†êÏàò', 'Ï†ÑÎûµÏ†ÅÏÇ¨Í≥† Ï†êÏàò', 'Ï†ÑÏ≤¥ÌèâÍ∑†',
                '1ÏúÑ Í∞ïÏ†ê', '2ÏúÑ Í∞ïÏ†ê', '3ÏúÑ Í∞ïÏ†ê', '4ÏúÑ Í∞ïÏ†ê', '5ÏúÑ Í∞ïÏ†ê'
            ];

            // CSV Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
            const csvData = filteredAssessments.map(assessment => {
                const student = assessment.studentInfo;
                const domainScores = assessment.domainScores || {};
                const topStrengths = assessment.topStrengths || [];
                
                const executing = domainScores.executing?.score?.toFixed(1) || '0.0';
                const influencing = domainScores.influencing?.score?.toFixed(1) || '0.0';
                const relationship = domainScores.relationship?.score?.toFixed(1) || '0.0';
                const strategic = domainScores.strategic?.score?.toFixed(1) || '0.0';
                
                const overall = calculateStudentAverage(assessment);
                const completedDate = new Date(assessment.completedAt).toLocaleString('ko-KR');

                return [
                    student.name,
                    student.grade + 'ÌïôÎÖÑ',
                    student.studentId,
                    student.gender,
                    completedDate,
                    executing,
                    influencing,
                    relationship,
                    strategic,
                    overall,
                    topStrengths[0]?.korean || '',
                    topStrengths[1]?.korean || '',
                    topStrengths[2]?.korean || '',
                    topStrengths[3]?.korean || '',
                    topStrengths[4]?.korean || ''
                ];
            });

            // CSV Î¨∏ÏûêÏó¥ ÏÉùÏÑ±
            const csvContent = [headers, ...csvData]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            // UTF-8 BOM Ï∂îÍ∞Ä (ÌïúÍ∏Ä Íπ®Ïßê Î∞©ÏßÄ)
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

            // Îã§Ïö¥Î°úÎìú
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Í∞ïÏ†êÍ≤ÄÏÇ¨Í≤∞Í≥º_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
